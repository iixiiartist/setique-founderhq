name: Daily Database Backup

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
      
      - name: Create backup
        env:
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          DATE=$(date +%Y-%m-%d_%H-%M-%S)
          BACKUP_FILE="founderhq_backup_${DATE}.sql"
          
          echo "Creating backup: $BACKUP_FILE"
          
          PGPASSWORD="$SUPABASE_DB_PASSWORD" pg_dump \
            -h db.${SUPABASE_PROJECT_REF}.supabase.co \
            -U postgres \
            -d postgres \
            --no-owner \
            --no-acl \
            -F c \
            -f "$BACKUP_FILE"
          
          # Compress backup
          gzip "$BACKUP_FILE"
          
          # Get file size
          SIZE=$(du -h "${BACKUP_FILE}.gz" | cut -f1)
          echo "Backup size: $SIZE"
          echo "BACKUP_FILE=${BACKUP_FILE}.gz" >> $GITHUB_ENV
          echo "BACKUP_SIZE=$SIZE" >> $GITHUB_ENV
      
      - name: Upload to artifact
        uses: actions/upload-artifact@v4
        with:
          name: database-backup-${{ github.run_number }}
          path: founderhq_backup_*.sql.gz
          retention-days: 30
      
      - name: Create backup summary
        run: |
          echo "# Database Backup Complete âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **File**: ${{ env.BACKUP_FILE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Size**: ${{ env.BACKUP_SIZE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Retention**: 30 days" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Backup is stored in GitHub Actions artifacts and will be automatically deleted after 30 days." >> $GITHUB_STEP_SUMMARY
      
      # Optional: Notify on failure
      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Database backup failed! Check logs immediately."
          # Add Slack/email notification here if needed

  # Optional: Upload to S3 for long-term storage
  # upload-to-s3:
  #   needs: backup
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Download backup artifact
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: database-backup-${{ github.run_number }}
  #     
  #     - name: Configure AWS credentials
  #       uses: aws-actions/configure-aws-credentials@v4
  #       with:
  #         aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
  #         aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  #         aws-region: us-east-1
  #     
  #     - name: Upload to S3
  #       run: |
  #         aws s3 cp founderhq_backup_*.sql.gz \
  #           s3://your-backup-bucket/founderhq/$(date +%Y)/$(date +%m)/ \
  #           --storage-class STANDARD_IA
  #     
  #     - name: Clean old S3 backups
  #       run: |
  #         # Delete backups older than 90 days
  #         aws s3 ls s3://your-backup-bucket/founderhq/ --recursive | \
  #           awk '{if (NR > 90) print $4}' | \
  #           xargs -I {} aws s3 rm s3://your-backup-bucket/{}
