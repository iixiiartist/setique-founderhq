name: CI - Test, Lint, and Build

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch: # Allow manual trigger

# Cancel in-progress runs when a new push occurs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Environment validation and setup
  validate-env:
    name: Validate Environment Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Validate environment configuration
        run: node scripts/validate-env.js
        env:
          # Set minimal required env vars for validation
          VITE_SUPABASE_URL: https://example.supabase.co
          VITE_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9
          VITE_APP_URL: https://founderhq.app
          VITE_ENVIRONMENT: production
          VITE_STRIPE_PUBLISHABLE_KEY: pk_test_example
          CI: true

  # Type checking
  type-check:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    needs: validate-env
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run type check
        run: npm run type-check

  # Linting
  lint:
    name: ESLint Code Quality
    runs-on: ubuntu-latest
    needs: validate-env
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint
        run: npm run lint

  # Unit and integration tests
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: validate-env
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run unit tests
        run: npm test
        env:
          # Mock environment for tests
          VITE_SUPABASE_URL: https://test.supabase.co
          VITE_SUPABASE_ANON_KEY: test-key
          VITE_APP_URL: http://localhost:3000
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
        continue-on-error: true

  # Build verification
  build:
    name: Production Build
    runs-on: ubuntu-latest
    needs: [type-check, lint, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build application
        run: npm run build
        env:
          # Minimal env vars for build
          VITE_SUPABASE_URL: https://placeholder.supabase.co
          VITE_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9
          VITE_APP_URL: https://founderhq.app
          VITE_ENVIRONMENT: production
          VITE_STRIPE_PUBLISHABLE_KEY: pk_live_placeholder
          CI: true
      
      - name: Check build output
        run: |
          if [ ! -d "dist" ]; then
            echo "Error: dist directory not created"
            exit 1
          fi
          if [ ! -f "dist/index.html" ]; then
            echo "Error: index.html not found in dist"
            exit 1
          fi
          echo "Build artifacts verified successfully"
          ls -lah dist/
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/
          retention-days: 7

  # Docker build verification
  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: founderhq:ci-test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=production

  # Summary job - all checks must pass
  ci-success:
    name: All CI Checks Passed
    runs-on: ubuntu-latest
    needs: [validate-env, type-check, lint, test, build, docker-build]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [ "${{ needs.validate-env.result }}" != "success" ] ||
             [ "${{ needs.type-check.result }}" != "success" ] ||
             [ "${{ needs.lint.result }}" != "success" ] ||
             [ "${{ needs.test.result }}" != "success" ] ||
             [ "${{ needs.build.result }}" != "success" ] ||
             [ "${{ needs.docker-build.result }}" != "success" ]; then
            echo "One or more CI jobs failed"
            exit 1
          fi
          echo "All CI checks passed successfully! ✅"
      
      - name: Create summary
        run: |
          echo "# CI Checks Complete ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All quality checks passed:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Environment validation" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ TypeScript type checking" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ ESLint code quality" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Unit tests" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Production build" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Docker image build" >> $GITHUB_STEP_SUMMARY
